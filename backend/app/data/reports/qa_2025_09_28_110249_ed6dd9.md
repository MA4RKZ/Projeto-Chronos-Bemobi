# Análise - Débito Recorrente – primeira cobrança falhou
*Área:* debit_recurring

## Evidências
- app/data/uploads/evidencia_debito_recorrente_primeira_falha.txt

## Trecho extraído
```
Caso: débito recorrente – falha na primeira cobrança (saldo insuficiente)

Plano:
- Assinatura mensal R$ 29,90
- Cartão final 1234

Passos:
1) Criação de assinatura
2) Agendamento de cobrança D0
3) Tentativa automática de cobrança

Logs:
[09:00:10.100] subscription:create id=SUB-555 user=U-2025 plan=Mensal
[09:00:12.200] charge:attempt subscription=SUB-555 amount=29.90
[09:00:12.980] charge:failed reason=insufficient_funds code=402

Política de dunning:
- D0: e-mail de lembrete (enviado ✔)
- D3: SMS (não evidenciado)
- D7: bloqueio parcial (não evidenciado)

Webhooks:
[09:00:13.120] webhook: payment_failed subscription=SUB-555 signature=sha256=9F0A...

Controles:
- Validação de assinatura do webhook: OK
- Idempotência na criação de eventos: sem evidência

Resultado esperado:
- registro de falha + agenda de dunning (D3, D7)
Resultado observado:
- Apenas e-mail D0 evidenciado; demais etapas ausentes

```

## Saída do LLM (raw)
```
```json
{
  "title": "Débito Recorrente – primeira cobrança falhou",
  "evaluation": {
    "criteria": [
      {
        "name": "msg de erro",
        "result": "Ausente",
        "reason": "Não foi evidenciada nenhuma mensagem de erro durante a tentativa de cobrança."
      },
      {
        "name": "retry_policy",
        "result": "Ausente",
        "reason": "Não há evidência de uma política de retry configurada para lidar com falhas temporárias."
      },
      {
        "name": "idempotencia",
        "result": "Ausente",
        "reason": "Não foi evidenciada nenhuma implementação que garantisse a idempotência das tentativas de cobrança."
      }
    ]
  },
  "suggestions": [
    "Implementar uma mensagem de erro detalhada para fornecer mais contexto sobre o motivo da falha.",
    "Desenvolver e configurar uma política de retry com intervalos exponenciais ou cíclicos, dependendo do cenário.",
    "Garantir que as tentativas de cobrança sejam idempotentes, evitando processos duplicados."
  ],
  "additional_cases": [
    {
      "title": "Débito Recorrente – falha em D3",
      "description": "A segunda tentativa de cobrança (D3) deve ser configurada para enviar um SMS de lembrete.",
      "expected_result": "SMS enviado com sucesso após a tentativa automática de cobrança."
    },
    {
      "title": "Débito Recorrente – falha em D7",
      "description": "A quarta tentativa de cobrança (D7) deve bloquear parcialmente o acesso do usuário.",
      "expected_result": "Bloqueio parcial do acesso do usuário após a tentativa automática de cobrança."
    },
    {
      "title": "Débito Recorrente – falha em D10",
      "description": "A sexta tentativa de cobrança (D10) deve realizar uma segunda tentativa de cobrança.",
      "expected_result": "Segunda tentativa de cobrança realizada após a tentativa automática de cobrança."
    }
  ]
}
``
```